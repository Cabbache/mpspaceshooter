<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      background-color: grey;
    }
  </style>
</head>
<body>
<script>

var opened = false;
var socket = null;

const recvFn = (event) => {
	console.log(event.data);
};

fetch("http://127.0.0.1:8000/register", {
	method: 'POST',
	headers: {
		'Content-Type': 'application/json'
	},
	body: "{}"
})
.then(response => response.json())
.then(result => {
	socket = new WebSocket("ws://127.0.0.1:8000/ws/"+result['private']);
	socket.onmessage = recvFn;
	socket.onopen = () => {
		opened=true;
		socket.send(JSON.stringify({"t":"StateQuery"}));
	};
	socket.onclose = (event)=>{
		opened=false;
		console.log(event.wasClean ? "closed cleanly":"connection died");
	}
});

window.addEventListener('keydown', (event) => keyAction(event.repeat, event.keyCode, event.key, false));
window.addEventListener('keyup', (event) => keyAction(event.repeat, event.keyCode, event.key, true));

function keyAction(repeated, code, name, up){
	if (!opened || repeated) return;

	let goodKeys = ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];
	if (goodKeys.includes(name)){
		socket.send("{\"z\":\"aa\"}");
		socket.send(
			JSON.stringify({
				"t":"KeyUpdate",
				"c":{
					"keyname": name,
					"up": up
				 }
			})
		);
	}
}

</script>
</body>
</html>
